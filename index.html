<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Chattia — OPS AI Chatbot</title>

<!-- Patched FontAwesome (CSP + SRI + CORS Safe) -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-RXf+QSDCUqpphKAa+WAc3XQ8fE5H1aO/8e2wY+8Q1n8yVwDh1RZTf1TDN8E+u1n7eU5KyY7X2Qo+hqeZZn+UAQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
/* ---------- COLOR SYSTEM ---------- */
:root {
  --clr-primary:#00c4ff;
  --clr-accent:#ff3bdb;
  --clr-bg:#ffffff;
  --clr-bg-dark:#121212;
  --clr-tx:#333333;
  --clr-tx-dark:#f0f0f0;
}
body {
  margin:0;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--clr-bg);
  color:var(--clr-tx);
  transition:background .3s,color .3s;
}
body.dark {
  --clr-bg:var(--clr-bg-dark);
  --clr-tx:var(--clr-tx-dark);
}

/* ---------- CHATBOT ---------- */
#chatbot-container {
  width:300px;
  height:540px;
  background:#251541;
  border:2px solid var(--clr-accent);
  border-radius:18px;
  box-shadow:0 8px 32px #0006;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#chatbot-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.5rem;
  background:linear-gradient(135deg,var(--clr-primary) 0%,var(--clr-accent) 100%);
  color:#fff;
  font-weight:600;
  font-size:1.1rem;
  padding:.75rem 1rem;
}
#chatbot-header .ctrl-group {
  display:flex;
  align-items:center;
  gap:.3rem;
}
#chatbot-header .ctrl {
  cursor:pointer;
  font-size:.75rem;
  font-weight:600;
  user-select:none;
  opacity:.9;
  color:inherit;
  background:transparent;
  border:1px solid #fff5;
  border-radius:6px;
  padding:.2rem .45rem;
  transition:background .2s, color .2s, opacity .2s;
}
#chatbot-header .ctrl:hover {
  opacity:1;
  background:#fff2;
}
#chatbot-header .ctrl.lang.active {
  background:#fff;
  color:#321b53;
  opacity:1;
}
#chat-log {
  flex:1;
  overflow-y:auto;
  padding:1rem;
  background:#1b0e2d;
  color:#eee;
  font-size:.94rem;
}
.chat-msg {
  margin:.5rem 0;
  max-width:90%;
}
.user {
  margin-left:auto;
  background:var(--clr-primary);
  color:#000;
  padding:.5rem .7rem;
  border-radius:14px 14px 0 14px;
}
.bot {
  margin-right:auto;
  background:#321b53;
  color:#fff;
  padding:.5rem .7rem;
  border-radius:14px 14px 14px 0;
}
#chatbot-form-container {
  background:#220f3a;
  border-top:1px solid var(--clr-accent);
  padding:.55rem .7rem;
}
#chatbot-input-row {
  display:flex;
  gap:.6rem;
}
#chatbot-input {
  flex:1;
  background:transparent;
  border:none;
  color:#fff;
  font-size:.95rem;
  padding:.55rem .6rem;
}
#chatbot-input::placeholder {
  color:#bfbfbf;
}
#chatbot-send {
  display:flex;
  align-items:center;
  gap:6px;
  background:var(--clr-accent);
  border:none;
  color:#fff;
  font-weight:600;
  padding:.5rem .9rem;
  border-radius:8px;
  cursor:pointer;
  transition:.3s;
}
#chatbot-send i {
  transition:transform .3s;
}
#chatbot-send:hover i {
  transform:rotate(-45deg);
}

@media (max-width:480px) {
  #chatbot-container {
    height:75vh;
    width:90%;
  }
}
</style>
</head>
<body>

<!-- ---------- CHATBOT HTML ---------- -->
<div id="chatbot-container" role="dialog" aria-modal="true">
  <div id="chatbot-header">
    <span id="title"
          data-en="OPS AI Chatbot"
          data-es="Chatbot OPS AI">OPS AI Chatbot</span>

    <!-- tiny controls -->
    <div class="ctrl-group" aria-label="Language and theme controls">
      <button type="button" class="ctrl lang active" data-lang="en">EN</button>
      <button type="button" class="ctrl lang" data-lang="es">ES</button>
      &nbsp;|&nbsp;
      <button type="button" id="themeCtrl" class="ctrl">Dark</button>
    </div>
  </div>

  <div id="chat-log" aria-live="polite"></div>

  <div id="chatbot-form-container">
    <form id="chatbot-input-row" autocomplete="off">
      <input
        id="chatbot-input"
        type="text"
        placeholder="Type your message..."
        required
        maxlength="256"
        data-en-ph="Type your message..."
        data-es-ph="Escriba su mensaje...">
      <button id="chatbot-send" type="submit" aria-label="Send">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<!-- ---------- CHATBOT LOGIC ---------- -->
<script>
const qs  = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];

// === Language toggle ===
const langButtons = qsa('[data-lang]');
const transNodes  = qsa('[data-en]');
const phNodes     = qsa('[data-en-ph]');

function setLanguage(lang) {
  const toES = lang === 'es';
  document.documentElement.lang = toES ? 'es' : 'en';

  langButtons.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  transNodes.forEach(node => {
    node.textContent = toES ? node.dataset.es : node.dataset.en;
  });

  phNodes.forEach(node => {
    node.placeholder = toES ? node.dataset.esPh : node.dataset.enPh;
  });
}

langButtons.forEach(btn => {
  btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
});

setLanguage(document.documentElement.lang === 'es' ? 'es' : 'en');

// === Theme toggle ===
const themeCtrl = qs('#themeCtrl');
themeCtrl.onclick = () => {
  const dark = themeCtrl.textContent === 'Dark';
  document.body.classList.toggle('dark', dark);
  themeCtrl.textContent = dark ? 'Light' : 'Dark';
};

// === Chatbot core (linked to LLM Chat App Worker) ===
const log   = qs('#chat-log');
const form  = qs('#chatbot-input-row');
const input = qs('#chatbot-input');

// Backend endpoint for Chattia (Cloudflare Worker)
const API_URL = new URL('https://ops-online-assistant.grabem-holdem-nuts-right.workers.dev/api/ops-online-chat');

function addMsg(txt, cls) {
  const div = document.createElement('div');
  div.className = 'chat-msg ' + cls;
  div.textContent = txt;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
  return div;
}

form.onsubmit = async e => {
  e.preventDefault();

  const msg = input.value.trim();
  if (!msg) return;

  const lang = (document.documentElement.lang === 'es') ? 'es' : 'en';

  // user bubble
  addMsg(msg, 'user');
  input.value = '';

  // temporary bot bubble
  const botDiv = addMsg('…', 'bot');

  try {
    const res = await fetch(API_URL.href, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, lang })
    });

    const data = await res.json();
    const reply = data && data.reply
      ? data.reply
      : (lang === 'es' ? 'Sin respuesta.' : 'No reply.');

    botDiv.textContent = reply;
  } catch (err) {
    botDiv.textContent = (lang === 'es')
      ? 'Error: no puedo conectar con Chattia.'
      : 'Error: can’t reach Chattia.';
  }
};
</script>
</body>
</html>
