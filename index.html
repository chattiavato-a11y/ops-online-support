<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>OPS AI Chatbot</title>

<!-- Patched FontAwesome (CSP + SRI + CORS Safe) -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-RXf+QSDCUqpphKAa+WAc3XQ8fE5H1aO/8e2wY+8Q1n8yVwDh1RZTf1TDN8E+u1n7eU5KyY7X2Qo+hqeZZn+UAQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
/* ---------- COLOR SYSTEM ---------- */
:root {
  --clr-primary:#00c4ff;
  --clr-accent:#ff3bdb;
  --clr-bg:#ffffff;
  --clr-bg-dark:#121212;
  --clr-tx:#333333;
  --clr-tx-dark:#f0f0f0;
}
body {
  margin:0;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--clr-bg);
  color:var(--clr-tx);
  transition:background .3s,color .3s;
}
body.dark {
  --clr-bg:var(--clr-bg-dark);
  --clr-tx:var(--clr-tx-dark);
}

/* ---------- CONSENT BANNER ---------- */
#consent-banner {
  max-width:900px;
  background:#0d0b1e;
  color:#f5f7fb;
  border:2px solid var(--clr-primary);
  border-radius:14px;
  padding:1rem 1.25rem;
  margin-bottom:1rem;
  box-shadow:0 10px 25px #0005;
}
#consent-banner a {
  color:var(--clr-primary);
  font-weight:600;
}
#consent-banner .consent-row {
  display:flex;
  align-items:center;
  gap:.65rem;
  margin-top:.75rem;
  flex-wrap:wrap;
}
#consentToggle {
  width:18px;
  height:18px;
}
#consent-status {
  font-size:.95rem;
}

/* ---------- CHATBOT ---------- */
#chatbot-container {
  width:300px;
  height:540px;
  background:#251541;
  border:2px solid var(--clr-accent);
  border-radius:18px;
  box-shadow:0 8px 32px #0006;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#chatbot-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.5rem;
  background:linear-gradient(135deg,var(--clr-primary) 0%,var(--clr-accent) 100%);
  color:#fff;
  font-weight:600;
  font-size:1.1rem;
  padding:.75rem 1rem;
}
#chatbot-header .ctrl-group {
  display:flex;
  align-items:center;
  gap:.3rem;
}
#chatbot-header .ctrl {
  cursor:pointer;
  font-size:.75rem;
  font-weight:600;
  user-select:none;
  opacity:.9;
  color:inherit;
  background:transparent;
  border:1px solid #fff5;
  border-radius:6px;
  padding:.2rem .45rem;
  transition:background .2s, color .2s, opacity .2s;
}
#chatbot-header .ctrl:hover {
  opacity:1;
  background:#fff2;
}
#chatbot-header .ctrl.lang.active {
  background:#fff;
  color:#321b53;
  opacity:1;
}
#chat-log {
  flex:1;
  overflow-y:auto;
  padding:1rem;
  background:#1b0e2d;
  color:#eee;
  font-size:.94rem;
}
.chat-msg {
  margin:.5rem 0;
  max-width:90%;
}
.user {
  margin-left:auto;
  background:var(--clr-primary);
  color:#000;
  padding:.5rem .7rem;
  border-radius:14px 14px 0 14px;
}
.bot {
  margin-right:auto;
  background:#321b53;
  color:#fff;
  padding:.5rem .7rem;
  border-radius:14px 14px 14px 0;
}
#chatbot-form-container {
  background:#220f3a;
  border-top:1px solid var(--clr-accent);
  padding:.55rem .7rem;
}
#chatbot-input-row {
  display:flex;
  gap:.6rem;
}
#listenCtrl {
  background:#ffb703;
  border:none;
  color:#1b0e2d;
  font-weight:700;
  padding:.45rem .65rem;
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform .2s, box-shadow .2s;
}
#listenCtrl .btn-label {
  margin-left:.35rem;
  font-weight:700;
}
#listenCtrl.active {
  box-shadow:0 0 0 2px #fff3;
  transform:scale(1.02);
}
#listenCtrl i { pointer-events:none; }
#chatbot-input {
  flex:1;
  background:transparent;
  border:none;
  color:#fff;
  font-size:.95rem;
  padding:.55rem .6rem;
}
#chatbot-input::placeholder {
  color:#bfbfbf;
}
#chatbot-send {
  display:flex;
  align-items:center;
  gap:6px;
  background:var(--clr-accent);
  border:none;
  color:#fff;
  font-weight:600;
  padding:.5rem .9rem;
  border-radius:8px;
  cursor:pointer;
  transition:.3s;
}
#chatbot-send i {
  transition:transform .3s;
}
#chatbot-send:hover i {
  transform:rotate(-45deg);
}

@media (max-width:480px) {
  #chatbot-container {
    height:75vh;
    width:90%;
  }
}
</style>
</head>
<body>

<div id="consent-banner" role="region" aria-live="polite">
  <p
    data-en="We process your chat and optional voice input to respond. Audio stays in your browser; typed messages are sent to our service. Please review our"
    data-es="Procesamos tu chat y la entrada de voz opcional para responder. El audio permanece en tu navegador; los mensajes escritos se envían a nuestro servicio. Revisa nuestra">
    We process your chat and optional voice input to respond. Audio stays in your browser; typed messages are sent to our service. Please review our
    <a href="#" target="_blank" rel="noreferrer noopener">Privacy Policy</a>
    &amp;
    <a href="#" target="_blank" rel="noreferrer noopener">Terms of Service</a>
    before proceeding.
  </p>
  <div class="consent-row">
    <label for="consentToggle" data-en="I consent to send my messages for processing." data-es="Consiento enviar mis mensajes para su procesamiento.">
      I consent to send my messages for processing.
    </label>
    <input type="checkbox" id="consentToggle" aria-describedby="consent-status">
    <span id="consent-status"></span>
  </div>
</div>

<!-- ---------- CHATBOT HTML ---------- -->
<div id="chatbot-container" role="dialog" aria-modal="true">
  <div id="chatbot-header">
    <span id="title"
          data-en="OPS AI Chatbot"
          data-es="Chatbot OPS AI">OPS AI Chatbot</span>

    <!-- tiny controls -->
    <div class="ctrl-group" aria-label="Language and theme controls">
      <button type="button" class="ctrl lang active" data-lang="en">EN</button>
      <button type="button" class="ctrl lang" data-lang="es">ES</button>
      &nbsp;|&nbsp;
      <button type="button" id="themeCtrl" class="ctrl">Dark</button>
      &nbsp;|&nbsp;
      <button type="button" id="speechToggle" class="ctrl"
        data-en="Speech"
        data-es="Voz">Speech</button>
    </div>
  </div>

  <div id="chat-log" aria-live="polite"></div>

  <div id="chatbot-form-container">
    <form id="chatbot-input-row" autocomplete="off">
      <input
        id="chatbot-input"
        type="text"
        placeholder="Type your message..."
        required
        maxlength="256"
        data-en-ph="Type your message..."
        data-es-ph="Escriba su mensaje...">
      <button id="listenCtrl" type="button" aria-label="Start voice input"
        data-en-label="Start voice input"
        data-es-label="Comenzar voz">
        <i class="fas fa-microphone"></i>
        <span class="btn-label" data-en="Speak" data-es="Hablar">Speak</span>
      </button>
      <button id="chatbot-send" type="submit" aria-label="Send">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<!-- ---------- CHATBOT LOGIC ---------- -->
<script>
const qs  = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];

/* ===== Fixed asset ID: repo → gateway (ONLY) ===== */
const ASSET_ID = "CAFF600A21B457E5D909FD887AF48018B3CBFDDF6F9746E56238B23AF061F9E2";

/* ===== Expected origin (GitHub Pages) ===== */
const EXPECTED_ORIGIN = "https://chattiavato-a11y.github.io";

/* ===== Language / UI wiring ===== */
const langButtons = qsa('[data-lang]');
const transNodes  = qsa('[data-en]');
const phNodes     = qsa('[data-en-ph]');
const ariaNodes   = qsa('[data-en-label]');

const speechToggle = qs('#speechToggle');
const listenCtrl   = qs('#listenCtrl');
const log   = qs('#chat-log');
const form  = qs('#chatbot-input-row');
const input = qs('#chatbot-input');
const consentToggle = qs('#consentToggle');
const consentStatus = qs('#consent-status');
const sendBtn = qs('#chatbot-send');

const CONSENT_KEY = 'opsChatConsent';
let consentGranted = localStorage.getItem(CONSENT_KEY) === 'true';

let currentLang = document.documentElement.lang === 'es' ? 'es' : 'en';

const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;
const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = Recognition ? new Recognition() : null;
let listening = false;
let speechEnabled = false;

// Security: if someone opens this file from a different origin, show a clear message
let originLocked = false;
if (window.location.origin !== EXPECTED_ORIGIN) {
  originLocked = true;
  addMsg(
    "OPS assistant only works from " + EXPECTED_ORIGIN + "/ops-online-support/ for security reasons.",
    "bot"
  );
}

if (recognition) {
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = currentLang === 'es' ? 'es-ES' : 'en-US';
}

function updateSpeechToggleUI() {
  speechToggle.classList.toggle('active', speechEnabled);
  speechToggle.setAttribute('aria-pressed', speechEnabled ? 'true' : 'false');
}

function updateConsentUI() {
  consentToggle.checked = consentGranted;
  const consentNeeded = !consentGranted;
  speechToggle.disabled = consentNeeded;
  listenCtrl.disabled = consentNeeded;
  sendBtn.disabled = consentNeeded;
  input.disabled = consentNeeded;

  const statusText = consentGranted
    ? (currentLang === 'es'
      ? 'Consentimiento activo: puedes usar voz y enviar mensajes.'
      : 'Consent granted: voice and messages are enabled.')
    : (currentLang === 'es'
      ? 'Activa el consentimiento para habilitar voz y envíos.'
      : 'Turn on consent to enable voice and sending.');

  consentStatus.textContent = statusText;
  consentStatus.setAttribute('aria-live', 'polite');
}

function setConsent(granted) {
  consentGranted = granted;
  localStorage.setItem(CONSENT_KEY, granted ? 'true' : 'false');
  updateConsentUI();
}

function updateListenUI() {
  listenCtrl.classList.toggle('active', listening);
  listenCtrl.setAttribute('aria-pressed', listening ? 'true' : 'false');
}

function getVoiceForLang(langCode) {
  if (!synth) return null;
  const voices = synth.getVoices();
  const match = voices.find(v => v.lang.toLowerCase().startsWith(langCode));
  return match || voices.find(v => v.lang.toLowerCase().includes(langCode)) || null;
}

function speak(text) {
  if (!synth || !speechEnabled) return;
  synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  const langCode = currentLang === 'es' ? 'es-ES' : 'en-US';
  utter.lang = langCode;
  const voice = getVoiceForLang(currentLang);
  if (voice) utter.voice = voice;
  synth.speak(utter);
}

function startListening() {
  if (!recognition) return;
  recognition.lang = currentLang === 'es' ? 'es-ES' : 'en-US';
  listening = true;
  updateListenUI();
  recognition.start();
}

if (recognition) {
  recognition.onresult = event => {
    const transcript = event.results[0][0].transcript.trim();
    if (transcript) {
      // Dictation into the input box
      input.value = transcript;
      input.focus();
    }
  };

  recognition.onerror = () => {
    listening = false;
    updateListenUI();
  };

  recognition.onend = () => {
    listening = false;
    updateListenUI();
  };
}

function setLanguage(lang) {
  const toES = lang === 'es';
  currentLang = toES ? 'es' : 'en';
  document.documentElement.lang = currentLang;

  langButtons.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  transNodes.forEach(node => {
    node.textContent = toES ? node.dataset.es : node.dataset.en;
  });

  phNodes.forEach(node => {
    node.placeholder = toES ? node.dataset.esPh : node.dataset.enPh;
  });

  ariaNodes.forEach(node => {
    node.setAttribute('aria-label', toES ? node.dataset.esLabel : node.dataset.enLabel);
  });

  if (recognition) {
    recognition.lang = toES ? 'es-ES' : 'en-US';
  }

  updateConsentUI();
}

langButtons.forEach(btn => {
  btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
});

consentToggle.addEventListener('change', () => setConsent(consentToggle.checked));

function requireConsentMessage() {
  return currentLang === 'es'
    ? 'Activa el consentimiento para usar voz o enviar mensajes.'
    : 'Please enable consent to use voice or send messages.';
}

setLanguage(document.documentElement.lang === 'es' ? 'es' : 'en');
updateSpeechToggleUI();
updateListenUI();
updateConsentUI();

if (synth) {
  synth.onvoiceschanged = () => getVoiceForLang(currentLang);
}

/* ===== Theme toggle ===== */
const themeCtrl = qs('#themeCtrl');
themeCtrl.onclick = () => {
  const dark = themeCtrl.textContent === 'Dark';
  document.body.classList.toggle('dark', dark);
  themeCtrl.textContent = dark ? 'Light' : 'Dark';
};

speechToggle.onclick = () => {
  if (!consentGranted) {
    addMsg(requireConsentMessage(), 'bot');
    return;
  }
  if (!synth) {
    addMsg(currentLang === 'es'
      ? 'La síntesis de voz no está disponible.'
      : 'Speech synthesis is not available.', 'bot');
    return;
  }
  speechEnabled = !speechEnabled;
  updateSpeechToggleUI();
};

listenCtrl.onclick = () => {
  if (!consentGranted) {
    addMsg(requireConsentMessage(), 'bot');
    return;
  }
  if (!recognition) {
    addMsg(currentLang === 'es'
      ? 'Entrada por voz no disponible en este navegador.'
      : 'Voice input is not available in this browser.', 'bot');
    return;
  }

  if (listening) {
    recognition.stop();
    return;
  }

  startListening();
};

/* ===== Backend endpoint: repo → gateway ===== */
const API_URL = new URL(
  "https://ops-gateway.grabem-holdem-nuts-right.workers.dev/api/ops-online-chat"
);

function addMsg(txt, cls) {
  const div = document.createElement('div');
  div.className = 'chat-msg ' + cls;
  div.textContent = txt;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
  return div;
}

form.onsubmit = async e => {
  e.preventDefault();

  const msg = input.value.trim();
  if (!msg) return;

  if (!consentGranted) {
    addMsg(requireConsentMessage(), 'bot');
    return;
  }

  // If origin is not the official one, do not talk to gateway
  if (originLocked) {
    addMsg(
      currentLang === 'es'
        ? 'Por seguridad, el asistente solo está disponible desde la página oficial.'
        : 'For security, the assistant is only available from the official site.',
      'bot'
    );
    return;
  }

  const lang = (document.documentElement.lang === 'es') ? 'es' : 'en';

  // user bubble
  addMsg(msg, 'user');
  input.value = '';

  // temporary bot bubble
  const botDiv = addMsg('…', 'bot');

  try {
    const res = await fetch(API_URL.href, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // Asset ID from repo to gateway (ONLY)
        'X-Ops-Asset-Id': ASSET_ID
      },
      body: JSON.stringify({ message: msg, lang })
    });

    const data = await res.json().catch(() => null);

    if (!data) {
      const fallback = (lang === 'es')
        ? 'Error: respuesta no válida del gateway.'
        : 'Error: invalid response from gateway.';
      botDiv.textContent = fallback;
      speak(fallback);
      return;
    }

    if (data.error) {
      botDiv.textContent = data.error;
      speak(data.error);
      return;
    }

    const reply = data.reply
      ? data.reply
      : (lang === 'es' ? 'Sin respuesta.' : 'No reply.');

    botDiv.textContent = reply;
    speak(reply);
  } catch (err) {
    const fallback = (lang === 'es')
      ? 'Error: no puedo conectar con el asistente OPS.'
      : 'Error: can’t reach OPS assistant.';
    botDiv.textContent = fallback;
    speak(fallback);
  }
};
</script>
</body>
</html>

